{#
 # Customers Index - Using cp-table layout
 #
 # Global view of all customers across all campaigns with filters,
 # sorting, and bulk actions.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   PERMISSION CHECKS
   ============================================================================ #}

{% set canView = currentUser.can('campaignManager:viewCustomers') %}
{% set canDelete = currentUser.can('campaignManager:deleteCustomers') %}

{# ============================================================================
   GET QUERY PARAMETERS
   ============================================================================ #}

{% set search = craft.app.request.getParam('search', '') %}
{% set campaignFilter = craft.app.request.getParam('campaign', 'all') %}
{% set statusFilter = craft.app.request.getParam('status', 'all') %}
{% set siteFilterParam = craft.app.request.getParam('siteFilter', 'all') %}
{% set dateRange = craft.app.request.getParam('dateRange', 'all') %}
{% set sort = craft.app.request.getParam('sort', 'dateCreated') %}
{% set dir = craft.app.request.getParam('dir', 'desc') %}
{% set page = craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = 50 %}
{% set offset = (page - 1) * limit %}

{# ============================================================================
   DATE RANGE HELPER
   ============================================================================ #}

{% set today = "now"|date('Y-m-d') %}
{% set dateRanges = {
    'today': today,
    'yesterday': "now"|date_modify('-1 day')|date('Y-m-d'),
    'last7days': "now"|date_modify('-7 days')|date('Y-m-d'),
    'last30days': "now"|date_modify('-30 days')|date('Y-m-d'),
    'last90days': "now"|date_modify('-90 days')|date('Y-m-d'),
} %}

{# ============================================================================
   FILTER CUSTOMERS
   ============================================================================ #}

{% set filteredCustomers = customers %}

{# Campaign filter #}
{% if campaignFilter != 'all' %}
    {% set filteredCustomers = filteredCustomers|filter(c => c.campaignId == campaignFilter) %}
{% endif %}

{# Site filter #}
{% if siteFilterParam != 'all' %}
    {% set filteredCustomers = filteredCustomers|filter(c => c.siteId == siteFilterParam) %}
{% endif %}

{# Status filter #}
{% if statusFilter == 'pending' %}
    {% set filteredCustomers = filteredCustomers|filter(c => c.smsSendDate is null and c.emailSendDate is null) %}
{% elseif statusFilter == 'sent' %}
    {% set filteredCustomers = filteredCustomers|filter(c => c.smsSendDate is not null or c.emailSendDate is not null) %}
{% endif %}

{# Date range filter #}
{% if dateRange != 'all' and dateRanges[dateRange] is defined %}
    {% set startTimestamp = dateRanges[dateRange]|date('U') %}
    {% set filteredCustomers = filteredCustomers|filter(c => c.dateCreated|date('U') >= startTimestamp) %}
{% endif %}

{# Search filter #}
{% if search %}
    {% set filteredCustomers = filteredCustomers|filter(c =>
        search|lower in (c.name ?? '')|lower or
        search|lower in (c.email ?? '')|lower or
        search|lower in (c.sms ?? '')|lower
    ) %}
{% endif %}

{# Sort customers #}
{% if sort == 'name' %}
    {% set filteredCustomers = filteredCustomers|sort((a, b) => dir == 'asc' ? (a.name ?? '')|lower <=> (b.name ?? '')|lower : (b.name ?? '')|lower <=> (a.name ?? '')|lower) %}
{% elseif sort == 'campaign' %}
    {% set filteredCustomers = filteredCustomers|sort((a, b) => dir == 'asc' ? a.campaignId <=> b.campaignId : b.campaignId <=> a.campaignId) %}
{% elseif sort == 'sent' %}
    {% set filteredCustomers = filteredCustomers|sort((a, b) => dir == 'asc' ? (a.smsSendDate ?? a.emailSendDate ?? '')|date('U') <=> (b.smsSendDate ?? b.emailSendDate ?? '')|date('U') : (b.smsSendDate ?? b.emailSendDate ?? '')|date('U') <=> (a.smsSendDate ?? a.emailSendDate ?? '')|date('U')) %}
{% elseif sort == 'opened' %}
    {% set filteredCustomers = filteredCustomers|sort((a, b) => dir == 'asc' ? (a.smsOpenDate ?? a.emailOpenDate ?? '')|date('U') <=> (b.smsOpenDate ?? b.emailOpenDate ?? '')|date('U') : (b.smsOpenDate ?? b.emailOpenDate ?? '')|date('U') <=> (a.smsOpenDate ?? a.emailOpenDate ?? '')|date('U')) %}
{% elseif sort == 'dateCreated' %}
    {% set filteredCustomers = filteredCustomers|sort((a, b) => dir == 'asc' ? a.dateCreated|date('U') <=> b.dateCreated|date('U') : b.dateCreated|date('U') <=> a.dateCreated|date('U')) %}
{% endif %}

{% set totalCount = filteredCustomers|length %}
{% set paginatedCustomers = filteredCustomers|slice(offset, limit) %}

{# ============================================================================
   BUILD FILTER OPTIONS
   ============================================================================ #}

{# Campaign options #}
{% set campaignFilterOptions = [{value: 'all', label: 'All Campaigns'|t('campaign-manager'), status: 'all'}] %}
{% for option in campaignOptions %}
    {% set campaignFilterOptions = campaignFilterOptions|merge([{
        value: option.value,
        label: option.label,
    }]) %}
{% endfor %}

{# Site options #}
{% set siteFilterOptions = [{value: 'all', label: 'All Sites'|t('campaign-manager'), status: 'all'}] %}
{% for site in craft.app.sites.getAllSites() %}
    {% set siteFilterOptions = siteFilterOptions|merge([{
        value: site.id,
        label: site.name,
    }]) %}
{% endfor %}

{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: 'campaign-manager',
        name: settings.fullName,
    },
    page: {
        title: 'Customers'|t('campaign-manager'),
        subnav: 'customers',
        crumbs: [
            { label: settings.fullName, url: url('campaign-manager') },
            { label: 'Customers'|t('campaign-manager') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('campaign-manager'),
            colorSet: 'messageStatus',
            options: [
                {value: 'all', label: 'All'|t('campaign-manager'), status: 'all'},
                {value: 'pending', label: 'Pending'|t('campaign-manager'), colorKey: 'pending'},
                {value: 'sent', label: 'Sent'|t('campaign-manager'), colorKey: 'sent'},
            ],
        },
        {
            type: 'dropdown',
            param: 'campaign',
            current: campaignFilter,
            label: 'All Campaigns'|t('campaign-manager'),
            options: campaignFilterOptions,
        },
        {
            type: 'dropdown',
            param: 'siteFilter',
            current: siteFilterParam,
            label: 'All Sites'|t('campaign-manager'),
            options: siteFilterOptions,
        },
        {
            type: 'dropdown',
            param: 'dateRange',
            current: dateRange,
            label: 'All Time'|t('campaign-manager'),
            options: [
                {value: 'all', label: 'All Time'|t('campaign-manager')},
                {value: 'today', label: 'Today'|t('campaign-manager')},
                {value: 'yesterday', label: 'Yesterday'|t('campaign-manager')},
                {value: 'last7days', label: 'Last 7 Days'|t('campaign-manager')},
                {value: 'last30days', label: 'Last 30 Days'|t('campaign-manager')},
                {value: 'last90days', label: 'Last 90 Days'|t('campaign-manager')},
            ],
        },
    ],
    search: {
        placeholder: 'Search customers...'|t('campaign-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('campaign-manager'), sortable: true},
            {key: 'campaign', label: 'Campaign'|t('campaign-manager'), sortable: true},
            {key: 'contact', label: 'Contact'|t('campaign-manager')},
            {key: 'status', label: 'Status'|t('campaign-manager')},
            {key: 'sent', label: 'Sent'|t('campaign-manager'), sortable: true},
            {key: 'opened', label: 'Opened'|t('campaign-manager'), sortable: true},
            {key: 'submission', label: 'Submission'|t('campaign-manager')},
        ],
        items: paginatedCustomers,
        emptyMessage: 'No customers found.'|t('campaign-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'customer'|t('campaign-manager'), plural: 'customers'|t('campaign-manager')},
    },
    checkboxes: canDelete,
} %}


{# ============================================================================
   TOOLBAR ACTIONS (Export button)
   ============================================================================ #}

{% block toolbarActions %}
    {% include 'lindemannrock-base/_components/export-menu' with {
        action: 'campaign-manager/customers/export',
        permission: 'campaignManager:viewCustomers',
    } only %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('app') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row menu)
   ============================================================================ #}

{% block rowActions %}
    <td class="thin" style="text-align: right;">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
        <div class="menu">
            <ul>
                {% if item.submissionId %}
                    {% set submission = craft.formie.submissions.id(item.submissionId).one() %}
                    {% if submission %}
                        <li>
                            <a href="{{ submission.cpEditUrl }}">
                                {{ 'View Submission'|t('campaign-manager') }}
                            </a>
                        </li>
                        <li><hr class="padded"></li>
                    {% endif %}
                {% endif %}
                {% if canDelete %}
                    <li>
                        <a class="lr-customer-action error" data-action="delete" data-id="{{ item.id }}" data-name="{{ item.name }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {# Get campaign for this customer #}
    {% set campaign = craft.campaignManager.campaigns.getCampaignById(item.campaignId) %}
    {% set site = craft.app.sites.getSiteById(item.siteId) %}

    {# Determine status #}
    {% if item.smsSendDate or item.emailSendDate %}
        {% set statusValue = 'sent' %}
        {% set statusLabel = 'Sent'|t('campaign-manager') %}
    {% else %}
        {% set statusValue = 'pending' %}
        {% set statusLabel = 'Pending'|t('campaign-manager') %}
    {% endif %}

    {# Name #}
    <td>
        <span>{{ item.name }}</span>
        {% if site %}
            <span class="light" style="margin-left: 4px;">({{ site.language|upper[:2] }})</span>
        {% endif %}
    </td>

    {# Campaign #}
    <td>
        {% if campaign %}
            <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id, {site: site.handle ?? 'en'}) }}">
                {{ campaign.title }}
            </a>
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Contact (Email / SMS) #}
    <td>
        {% if item.email %}
            <code style="font-size: 11px;">{{ item.email }}</code>
        {% endif %}
        {% if item.email and item.sms %}<br>{% endif %}
        {% if item.sms %}
            <code style="font-size: 11px;">{{ item.sms }}</code>
        {% endif %}
        {% if not item.email and not item.sms %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Status indicator #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: statusLabel,
            value: statusValue,
            colorSet: 'messageStatus',
        } only %}
    </td>

    {# Sent date #}
    <td>
        {% set sentDate = item.smsSendDate ?? item.emailSendDate %}
        {% if sentDate %}
            {{ sentDate|date('Y-m-d H:i') }}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Opened date #}
    <td>
        {% set openedDate = item.smsOpenDate ?? item.emailOpenDate %}
        {% if openedDate %}
            {{ openedDate|date('Y-m-d H:i') }}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Submission #}
    <td>
        {% if item.submissionId %}
            {% set submission = craft.formie.submissions.id(item.submissionId).one() %}
            {% if submission %}
                <a href="{{ submission.cpEditUrl }}">{{ item.submissionId }}</a>
            {% else %}
                <span class="light">{{ item.submissionId }}</span>
            {% endif %}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Update selected count when selection changes
        document.addEventListener('lr:selectionChanged', function(e) {
            const countSpan = document.getElementById('lr-selected-count');
            if (countSpan) {
                countSpan.textContent = e.detail.count;
            }
        });

        // Bulk delete
        document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            const count = window.lrTableSelection.getCount();

            if (count === 0) return;

            if (!confirm('{{ "Delete {count} customer(s)? This cannot be undone."|t("campaign-manager")|e("js") }}'.replace('{count}', count))) {
                return;
            }

            Craft.sendActionRequest('POST', 'campaign-manager/customers/bulk-delete', {
                data: { customerIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Deleted {count} customers"|t("campaign-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to delete customers"|t("campaign-manager")|e("js") }}');
            });
        });

        // Individual customer action menu clicks
        document.querySelectorAll('.lr-customer-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const customerId = this.dataset.id;
                const customerName = this.dataset.name;

                if (action === 'delete') {
                    if (confirm('{{ "Delete customer \"{name}\"? This cannot be undone."|t("campaign-manager")|e("js") }}'.replace('{name}', customerName))) {
                        Craft.sendActionRequest('POST', 'campaign-manager/customers/delete-from-cp', {
                            data: { id: customerId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ "Customer deleted"|t("campaign-manager")|e("js") }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ "Failed to delete customer"|t("campaign-manager")|e("js") }}');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
