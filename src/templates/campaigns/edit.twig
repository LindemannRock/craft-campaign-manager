{% extends '_layouts/cp' %}
{% import '_includes/forms.twig' as forms %}

{% set plugin = craft.app.plugins.getPlugin('campaign-manager') %}
{% set settings = plugin.getSettings() %}
{% set selectedSubnavItem = 'campaigns' %}

{# Get site info for orientation (RTL support) #}
{% set currentSite = craft.app.sites.getSiteById(campaign.siteId) %}
{% set siteLocale = craft.app.i18n.getLocaleById(currentSite.language) %}
{% set siteOrientation = siteLocale.getOrientation() %}

{# Set up breadcrumbs #}
{% set crumbs = [] %}

{# Site switcher (first item) #}
{% if craft.app.getIsMultiSite() %}
    {% set crumbs = [{
        id: 'site-crumb',
        icon: 'world',
        label: currentSite.name|t('site'),
        menu: {
            items: siteMenuItems(null, currentSite),
            label: 'Select site'|t('app')
        }
    }] %}
{% endif %}

{# Main navigation #}
{% set crumbs = crumbs|merge([
    { label: settings.pluginName, url: cpUrl('campaign-manager') }
]) %}

{# Add campaign title or "New Campaign" crumb #}
{% if campaign.id %}
    {% set crumbs = crumbs|merge([
        { label: campaign.title }
    ]) %}
{% else %}
    {% set crumbs = crumbs|merge([
        { label: 'New Campaign'|t('campaign-manager') }
    ]) %}
{% endif %}

{% set fullPageForm = true %}
{% set saveShortcutRedirect = 'campaign-manager/campaigns/{id}?site=' ~ currentSite.handle %}

{# Set up tabs #}
{% set tabs = {
    'fields': { label: 'General'|t('campaign-manager'), url: '#fields' },
} %}

{# Add Analytics tab for existing campaigns (requires permission and enabled setting) #}
{% if campaign.id and currentUser.can('campaignManager:viewAnalytics') %}
    {% set tabs = tabs|merge({
        'analytics': { label: 'Analytics'|t('campaign-manager'), url: '#analytics' },
    }) %}
{% endif %}

{# Add Responses tab for existing campaigns with a form (requires permission) #}
{% if campaign.id and campaign.formId and currentUser.can('campaignManager:viewRecipients') %}
    {% set tabs = tabs|merge({
        'responses': { label: 'Responses'|t('campaign-manager'), url: '#responses' },
    }) %}
{% endif %}

{# Get field layout for rendering in General tab #}
{% set fieldLayout = campaign.getFieldLayout() %}

{% block actionButton %}
    <div class="btngroup submit">
        <button type="submit" class="btn submit">{{ 'Save'|t('app') }}</button>
        <button type="button" class="btn submit menubtn"></button>
        <div class="menu">
            <ul role="listbox">
                <li>
                    <a class="formsubmit" role="option" tabindex="0" data-redirect="{{ url('campaign-manager/campaigns/{id}', {site: currentSite.handle})|hash }}">
                        <span class="label">{{ 'Save and continue editing'|t('app') }}</span>
                        <span class="shortcut" id="save-shortcut"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    {% if campaign.id and currentUser.can('campaignManager:deleteCampaigns') %}
        <button type="button" id="action-btn" class="btn menubtn action-btn hairline-dark m" title="{{ 'Actions'|t('app') }}" aria-controls="action-menu" aria-label="{{ 'Actions'|t('app') }}" data-disclosure-trigger="true" aria-expanded="false"></button>
        <div id="action-menu" class="menu menu--disclosure">
            <ul>
                <li>
                    <button class="menu-item error formsubmit" data-destructive data-action="campaign-manager/campaigns/delete" data-params='{"campaignId":{{ campaign.id }}}' data-confirm="{{ 'Are you sure you want to delete this campaign?'|t('campaign-manager') }}" data-redirect="{{ 'campaign-manager'|hash }}" data-headers='{"Accept":"application/json"}'>
                        <span class="icon">{{ svg('@app/icons/trash.svg') }}</span>
                        <span class="menu-item-label">{{ 'Delete'|t('app') }}</span>
                    </button>
                </li>
            </ul>
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    {{ actionInput('campaign-manager/campaigns/save') }}
    {{ redirectInput('campaign-manager') }}
    {{ hiddenInput('siteId', campaign.siteId) }}
    {% if campaign.id %}
        {{ hiddenInput('campaignId', campaign.id) }}
    {% endif %}

    {# Duration units for invitation settings #}
    {% set durationUnits = [
        {label: 'Hours'|t('campaign-manager'), value: 'H'},
        {label: 'Days'|t('campaign-manager'), value: 'D'},
        {label: 'Weeks'|t('campaign-manager'), value: 'W'},
        {label: 'Months'|t('campaign-manager'), value: 'M'},
    ] %}

    {# Parse existing delay period - default to Hours #}
    {% set delayValue = '' %}
    {% set delayUnit = 'H' %}
    {% if campaign.invitationDelayPeriod matches '/^P(\\d+)([DWMY])$/' %}
        {% set delayValue = campaign.invitationDelayPeriod|replace('/[^0-9]/', '') %}
        {% set delayUnit = campaign.invitationDelayPeriod|slice(-1) %}
    {% elseif campaign.invitationDelayPeriod matches '/^PT(\\d+)H$/' %}
        {% set delayValue = campaign.invitationDelayPeriod|replace('/[^0-9]/', '') %}
        {% set delayUnit = 'H' %}
    {% endif %}

    {# Parse existing expiry period - default to Days #}
    {% set expiryValue = '' %}
    {% set expiryUnit = 'D' %}
    {% if campaign.invitationExpiryPeriod matches '/^P(\\d+)([DWMY])$/' %}
        {% set expiryValue = campaign.invitationExpiryPeriod|replace('/[^0-9]/', '') %}
        {% set expiryUnit = campaign.invitationExpiryPeriod|slice(-1) %}
    {% elseif campaign.invitationExpiryPeriod matches '/^PT(\\d+)H$/' %}
        {% set expiryValue = campaign.invitationExpiryPeriod|replace('/[^0-9]/', '') %}
        {% set expiryUnit = 'H' %}
    {% endif %}

    {# ==================== MAIN TAB ==================== #}
    <div id="fields">
        {# Title #}
        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: campaign.title,
            errors: campaign.getErrors('title'),
            first: true,
            autofocus: true,
            required: true,
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        {# Campaign Type #}
        {% if campaignTypeOptions %}
            {{ forms.selectField({
                label: 'Campaign Type'|t('campaign-manager'),
                id: 'campaignType',
                name: 'campaignType',
                value: campaign.campaignType,
                options: [{label: '', value: ''}]|merge(campaignTypeOptions|keys|map(k => {label: campaignTypeOptions[k], value: k})),
                errors: campaign.getErrors('campaignType'),
            }) }}
        {% endif %}

        {# Form - check ALL sites for responses since form is shared across sites #}
        {% if formOptions|length %}
            {% set hasResponses = campaign.id and campaign.hasSubmissionsAcrossAllSites() %}
            {{ forms.selectField({
                label: 'Form'|t('campaign-manager'),
                instructions: 'Select a Formie form to link with this campaign.'|t('campaign-manager'),
                id: 'formId',
                name: 'formId',
                value: campaign.formId,
                options: [{label: 'Select a form'|t('campaign-manager'), value: ''}]|merge(formOptions),
                errors: campaign.getErrors('formId'),
                required: true,
                disabled: hasResponses,
            }) }}
            {% if hasResponses %}
                {# Hidden input to preserve value when disabled #}
                {{ hiddenInput('formId', campaign.formId) }}
                {% include 'lindemannrock-base/_components/info-box' with {
                    type: 'warning',
                    message: 'The form cannot be changed because this campaign has responses. Changing the form would break existing response data.'|t('campaign-manager'),
                    margin: 'top',
                } %}
            {% endif %}
        {% endif %}

        <hr>

        <h2>{{ 'Invitation Settings'|t('campaign-manager') }}</h2>

        {# Invitation Delay Period #}
        <div class="field">
            <div class="heading">
                <label for="invitationDelayValue">{{ 'Invitation Delay'|t('campaign-manager') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'How long to wait before sending invitations after a recipient is added. Leave empty or 0 to send immediately.'|t('campaign-manager') }}</p>
            </div>
            <div class="flex">
                <div class="textwrapper">
                    {{ forms.text({
                        id: 'invitationDelayValue',
                        name: 'invitationDelayValue',
                        value: delayValue,
                        type: 'number',
                        min: 0,
                        size: 5,
                        placeholder: '0',
                    }) }}
                </div>
                <div>
                    {{ forms.select({
                        id: 'invitationDelayUnit',
                        name: 'invitationDelayUnit',
                        value: delayUnit,
                        options: durationUnits,
                    }) }}
                </div>
            </div>
            {% if campaign.getErrors('invitationDelayPeriod') %}
                <ul class="errors">
                    {% for error in campaign.getErrors('invitationDelayPeriod') %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        {# Invitation Expiry Period #}
        <div class="field">
            <div class="heading">
                <label for="invitationExpiryValue">{{ 'Invitation Expiry'|t('campaign-manager') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'How long the invitation link remains valid.'|t('campaign-manager') }}</p>
            </div>
            <div class="flex">
                <div class="textwrapper">
                    {{ forms.text({
                        id: 'invitationExpiryValue',
                        name: 'invitationExpiryValue',
                        value: expiryValue,
                        type: 'number',
                        min: 0,
                        size: 5,
                        placeholder: '0',
                    }) }}
                </div>
                <div>
                    {{ forms.select({
                        id: 'invitationExpiryUnit',
                        name: 'invitationExpiryUnit',
                        value: expiryUnit,
                        options: durationUnits,
                    }) }}
                </div>
            </div>
            {% if campaign.getErrors('invitationExpiryPeriod') %}
                <ul class="errors">
                    {% for error in campaign.getErrors('invitationExpiryPeriod') %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        <hr>

        {# ==================== MESSAGING SECTION (SMS + Email) ==================== #}
        <h2>{{ 'SMS Settings'|t('campaign-manager') }}</h2>

        {% if craft.campaignManager.sms.isSmsManagerAvailable() %}
            {# Build allowed countries and provider names by provider for JS #}
            {% set countriesByProvider = {} %}
            {% set providerNames = {} %}
            {% set countryNames = {} %}
            {% for provider in craft.campaignManager.sms.getAvailableProviders() %}
                {% set countries = craft.campaignManager.sms.getAllowedCountries(provider.handle) %}
                {% set countriesByProvider = countriesByProvider|merge({(provider.handle): countries}) %}
                {% set providerNames = providerNames|merge({(provider.handle): provider.name}) %}
                {# Build country names lookup #}
                {% for code in countries %}
                    {% if code != '*' and countryNames[code] is not defined %}
                        {% set countryNames = countryNames|merge({(code): lrCountryName(code)}) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {# Provider - use ?: to also handle empty strings #}
            {% set currentProviderHandle = campaign.providerHandle ?: settings.defaultProviderHandle %}
            {{ forms.selectField({
                label: 'Provider'|t('campaign-manager'),
                instructions: 'The SMS provider to use for this campaign.'|t('campaign-manager'),
                id: 'providerHandle',
                name: 'providerHandle',
                value: currentProviderHandle,
                options: providerOptions,
                errors: campaign.getErrors('providerHandle'),
            }) }}

            {# Sender ID - use ?: to also handle empty strings #}
            {% set currentSenderIdHandle = campaign.senderId ?: settings.defaultSenderIdHandle %}
            {{ forms.selectField({
                label: 'Sender ID'|t('campaign-manager'),
                instructions: 'The sender ID to display when sending SMS for this campaign.'|t('campaign-manager'),
                id: 'senderId',
                name: 'senderId',
                value: currentSenderIdHandle,
                options: senderIdOptions,
                errors: campaign.getErrors('senderId'),
                disabled: not currentProviderHandle,
            }) }}

            {# Show current provider's allowed countries #}
            {% set currentProvider = null %}
            {% for provider in craft.campaignManager.sms.getAvailableProviders() %}
                {% if provider.handle == currentProviderHandle %}
                    {% set currentProvider = provider %}
                {% endif %}
            {% endfor %}
            {% set currentCountries = currentProviderHandle ? craft.campaignManager.sms.getAllowedCountries(currentProviderHandle) : [] %}
            {% set formattedCountries = [] %}
            {% for code in currentCountries %}
                {% if code != '*' %}
                    {% set formattedCountries = formattedCountries|merge([lrCountryName(code) ~ ' (' ~ code ~ ')']) %}
                {% endif %}
            {% endfor %}
            {% set countryMessage = currentCountries == ['*'] ? 'Allowed countries for <strong>' ~ (currentProvider.name ?? '') ~ '</strong>: All countries.' : 'Allowed countries for <strong>' ~ (currentProvider.name ?? '') ~ '</strong>: ' ~ formattedCountries|join(', ') ~ '.' %}
            {% include 'lindemannrock-base/_components/info-box' with {
                message: countryMessage,
                type: 'info',
                margin: 'top',
                boxId: 'campaign-provider-countries-box',
                messageId: 'campaign-provider-countries-message',
                hidden: not currentProviderHandle,
            } %}

            {% js %}
                (function() {
                    var senderIdsByProvider = {{ senderIdsByProvider|json_encode|raw }};
                    var countriesByProvider = {{ countriesByProvider|json_encode|raw }};
                    var providerNames = {{ providerNames|json_encode|raw }};
                    var countryNames = {{ countryNames|json_encode|raw }};
                    var providerSelect = document.getElementById('providerHandle');
                    var senderIdSelect = document.getElementById('senderId');
                    var senderIdField = senderIdSelect.closest('.field');
                    var senderIdInput = senderIdSelect.closest('.input');
                    var countriesBox = document.getElementById('campaign-provider-countries-box');
                    var countriesMessage = document.getElementById('campaign-provider-countries-message');
                    var currentSenderIdValue = '{{ campaign.senderId|e('js') }}';

                    function formatCountry(code) {
                        var name = countryNames[code] || code;
                        return name + ' (' + code + ')';
                    }

                    function updateSenderIdOptions() {
                        var providerHandle = providerSelect.value;
                        var options = senderIdsByProvider[providerHandle] || [];

                        // Clear existing options
                        senderIdSelect.innerHTML = '';

                        // Add placeholder
                        var placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = providerHandle ? '{{ "Select a sender ID..."|t('campaign-manager')|e('js') }}' : '{{ "Select a provider first..."|t('campaign-manager')|e('js') }}';
                        senderIdSelect.appendChild(placeholder);

                        // Add sender ID options
                        options.forEach(function(opt) {
                            var option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            if (opt.value === currentSenderIdValue) {
                                option.selected = true;
                            }
                            senderIdSelect.appendChild(option);
                        });

                        // Enable/disable based on provider selection
                        var isDisabled = !providerHandle;
                        senderIdSelect.disabled = isDisabled;
                        if (senderIdInput) {
                            senderIdInput.classList.toggle('disabled', isDisabled);
                        }
                        if (senderIdField) {
                            senderIdField.classList.toggle('disabled', isDisabled);
                        }

                        // Update countries info box
                        if (countriesBox && countriesMessage) {
                            if (providerHandle) {
                                var countries = countriesByProvider[providerHandle] || [];
                                var providerName = providerNames[providerHandle] || providerHandle;
                                var message;
                                if (countries.length === 1 && countries[0] === '*') {
                                    message = '{{ "Allowed countries for"|t('campaign-manager')|e('js') }} <strong>' + providerName + '</strong>: {{ "All countries."|t('campaign-manager')|e('js') }}';
                                } else if (countries.length > 0) {
                                    var formatted = countries.map(formatCountry).join(', ');
                                    message = '{{ "Allowed countries for"|t('campaign-manager')|e('js') }} <strong>' + providerName + '</strong>: ' + formatted + '.';
                                } else {
                                    message = '{{ "No country restrictions for"|t('campaign-manager')|e('js') }} <strong>' + providerName + '</strong>.';
                                }
                                countriesMessage.innerHTML = message;
                                countriesBox.style.display = '';
                            } else {
                                countriesBox.style.display = 'none';
                            }
                        }
                    }

                    providerSelect.addEventListener('change', function() {
                        currentSenderIdValue = ''; // Reset when provider changes
                        updateSenderIdOptions();
                    });
                })();
            {% endjs %}
        {% else %}
            {% include 'lindemannrock-base/_components/info-box' with {
                type: 'notice',
                message: 'SMS Manager plugin is not installed or enabled. <a href="' ~ cpUrl('settings/plugins') ~ '">Enable SMS Manager</a> to configure SMS settings.'|t('campaign-manager')
            } %}
        {% endif %}

        {# SMS Invitation Message #}
        {{ forms.textareaField({
            label: 'SMS Invitation Message'|t('campaign-manager'),
            instructions: 'Use {invitationUrl} to include the invitation link.'|t('campaign-manager'),
            id: 'smsInvitationMessage',
            name: 'smsInvitationMessage',
            value: campaign.smsInvitationMessage,
            rows: 3,
            errors: campaign.getErrors('smsInvitationMessage'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        <hr>

        <h2>{{ 'Email Settings'|t('campaign-manager') }}</h2>

        {# Email Subject #}
        {{ forms.textField({
            label: 'Email Invitation Subject'|t('campaign-manager'),
            id: 'emailInvitationSubject',
            name: 'emailInvitationSubject',
            value: campaign.emailInvitationSubject,
            errors: campaign.getErrors('emailInvitationSubject'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        {# Email Invitation Message #}
        {{ forms.textareaField({
            label: 'Email Invitation Message'|t('campaign-manager'),
            instructions: 'Use {invitationUrl} to include the invitation link. HTML is supported.'|t('campaign-manager'),
            id: 'emailInvitationMessage',
            name: 'emailInvitationMessage',
            value: campaign.emailInvitationMessage,
            rows: 6,
            errors: campaign.getErrors('emailInvitationMessage'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        {# ==================== FIELD LAYOUT CONTENT ==================== #}
        {% if fieldLayout %}
            {% for tab in fieldLayout.getTabs() %}
                {% if tab.getElements()|length %}
                    <hr>
                    <h2>{{ tab.name }}</h2>
                    {% for element in tab.getElements() %}
                        {{ element.formHtml(campaign)|raw }}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    {# ==================== ANALYTICS TAB ==================== #}
    {% if campaign.id and currentUser.can('campaignManager:viewAnalytics') %}
        <div id="analytics" class="hidden">
            {% include 'campaign-manager/campaigns/_partials/analytics' %}
        </div>
    {% endif %}

    {# ==================== RESPONSES TAB ==================== #}
    {% if campaign.id and campaign.formId and currentUser.can('campaignManager:viewRecipients') %}
        <div id="responses" class="hidden">
            {% include 'campaign-manager/campaigns/_partials/responses' %}
        </div>
    {% endif %}
{% endblock %}

{% block details %}
    <div class="meta">
        {# Enabled #}
        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: campaign.getEnabledForSite(),
        }) }}

        {% set canViewRecipients = currentUser.can('campaignManager:viewRecipients') %}
        {% set canAddRecipients = currentUser.can('campaignManager:addRecipients') %}
        {% set canImportRecipients = currentUser.can('campaignManager:importRecipients') %}
        {% if campaign.id and (canViewRecipients or canAddRecipients or canImportRecipients) %}
            <div class="field" style="margin-top: 15px;">
                <div class="heading">
                    <label>{{ 'Actions'|t('app') }}</label>
                </div>
                <div class="input">
                    <div class="btngroup" style="width: 100%;">
                        <button type="button" class="btn menubtn" data-icon="settings" style="width: 100%;">{{ 'Campaign Actions'|t('campaign-manager') }}</button>
                        <div class="menu">
                            <ul>
                                {% if currentUser.can('campaignManager:viewRecipients') %}
                                    <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/recipients?site=' ~ currentSite.handle) }}">{{ 'View Recipients'|t('campaign-manager') }}</a></li>
                                {% endif %}
                                {% if campaign.getEnabledForSite() %}
                                    {% if currentUser.can('campaignManager:addRecipients') %}
                                        <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/add-recipient?site=' ~ currentSite.handle) }}">{{ 'Add Recipient'|t('campaign-manager') }}</a></li>
                                    {% endif %}
                                    {% if currentUser.can('campaignManager:importRecipients') %}
                                        <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/import-recipients?site=' ~ currentSite.handle) }}">{{ 'Import Recipients'|t('campaign-manager') }}</a></li>
                                    {% endif %}
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    {% if campaign.id %}
        <div class="meta read-only">
            <div class="data">
                <h5 class="heading">{{ 'Date Created'|t('app') }}</h5>
                <div class="value">{{ campaign.dateCreated|lrDatetime('short') }}</div>
            </div>
            <div class="data">
                <h5 class="heading">{{ 'Date Updated'|t('app') }}</h5>
                <div class="value">{{ campaign.dateUpdated|lrDatetime('short') }}</div>
            </div>
            <div class="data">
                <h5 class="heading">{{ 'Recipients'|t('campaign-manager') }}</h5>
                <div class="value">
                    {% if currentUser.can('campaignManager:viewRecipients') %}
                        <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/recipients?site=' ~ currentSite.handle) }}">
                            {{ campaign.recipientCount }}
                        </a>
                    {% else %}
                        {{ campaign.recipientCount }}
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% js %}
    // Set platform-specific keyboard shortcut
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    const saveShortcut = document.getElementById('save-shortcut');
    if (saveShortcut) {
        saveShortcut.textContent = isMac ? 'âŒ˜S' : 'Ctrl+S';
    }
{% endjs %}
