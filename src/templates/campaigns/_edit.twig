{% extends '_layouts/cp' %}
{% import '_includes/forms.twig' as forms %}

{% set plugin = craft.app.plugins.getPlugin('campaign-manager') %}
{% set settings = plugin.getSettings() %}

{# Get site info for orientation (RTL support) #}
{% set currentSite = craft.app.sites.getSiteById(campaign.siteId) %}
{% set siteLocale = craft.app.i18n.getLocaleById(currentSite.language) %}
{% set siteOrientation = siteLocale.getOrientation() %}

{# Set up breadcrumbs #}
{% set crumbs = [] %}

{# Site switcher (first item) #}
{% if craft.app.getIsMultiSite() %}
    {% set crumbs = [{
        id: 'site-crumb',
        icon: 'world',
        label: currentSite.name|t('site'),
        menu: {
            items: siteMenuItems(null, currentSite),
            label: 'Select site'|t('app')
        }
    }] %}
{% endif %}

{# Main navigation #}
{% set crumbs = crumbs|merge([
    { label: settings.pluginName, url: cpUrl('campaign-manager') }
]) %}

{% set fullPageForm = true %}
{% set saveShortcutRedirect = 'campaign-manager/campaigns/{id}?site=' ~ currentSite.handle %}

{# Set up tabs #}
{% set tabs = {
    'fields': { label: 'General'|t('campaign-manager'), url: '#fields' },
    'messaging': { label: 'Messaging'|t('campaign-manager'), url: '#messaging' },
} %}

{# Add field layout tabs #}
{% set fieldLayout = campaign.getFieldLayout() %}
{% if fieldLayout %}
    {% for tab in fieldLayout.getTabs() %}
        {% set tabId = 'tab-fl-' ~ tab.id %}
        {% set tabs = tabs|merge({ (tabId): { label: tab.name, url: '#' ~ tabId } }) %}
    {% endfor %}
{% endif %}

{% block actionButton %}
    <div class="btngroup submit">
        <button type="submit" class="btn submit">{{ 'Save'|t('app') }}</button>
        <button type="button" class="btn submit menubtn"></button>
        <div class="menu" data-align="right">
            <ul>
                <li>
                    <a class="formsubmit" data-redirect="{{ 'campaign-manager'|hash }}">
                        {{ 'Save and exit'|t('app') }}
                    </a>
                </li>
                {% if campaign.id %}
                    <li>
                        <a class="formsubmit" data-redirect="{{ ('campaign-manager/campaigns/new?site=' ~ currentSite.handle)|hash }}">
                            {{ 'Save and add another'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
            {% if campaign.id %}
                <hr>
                <ul>
                    <li>
                        <a class="formsubmit error"
                           data-action="campaign-manager/campaigns/delete"
                           data-confirm="{{ 'Are you sure you want to delete this campaign?'|t('campaign-manager') }}"
                           data-redirect="{{ 'campaign-manager'|hash }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                </ul>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}
    {{ actionInput('campaign-manager/campaigns/save') }}
    {{ redirectInput('campaign-manager/campaigns/{id}?site=' ~ currentSite.handle) }}
    {{ hiddenInput('siteId', campaign.siteId) }}
    {% if campaign.id %}
        {{ hiddenInput('campaignId', campaign.id) }}
    {% endif %}

    {# Duration units for invitation settings #}
    {% set durationUnits = [
        {label: 'Hours'|t('campaign-manager'), value: 'H'},
        {label: 'Days'|t('campaign-manager'), value: 'D'},
        {label: 'Weeks'|t('campaign-manager'), value: 'W'},
        {label: 'Months'|t('campaign-manager'), value: 'M'},
    ] %}

    {# Parse existing delay period - default to Hours #}
    {% set delayValue = '' %}
    {% set delayUnit = 'H' %}
    {% if campaign.invitationDelayPeriod matches '/^P(\\d+)([DWMY])$/' %}
        {% set delayValue = campaign.invitationDelayPeriod|replace('/[^0-9]/', '') %}
        {% set delayUnit = campaign.invitationDelayPeriod|slice(-1) %}
    {% elseif campaign.invitationDelayPeriod matches '/^PT(\\d+)H$/' %}
        {% set delayValue = campaign.invitationDelayPeriod|replace('/[^0-9]/', '') %}
        {% set delayUnit = 'H' %}
    {% endif %}

    {# Parse existing expiry period - default to Days #}
    {% set expiryValue = '' %}
    {% set expiryUnit = 'D' %}
    {% if campaign.invitationExpiryPeriod matches '/^P(\\d+)([DWMY])$/' %}
        {% set expiryValue = campaign.invitationExpiryPeriod|replace('/[^0-9]/', '') %}
        {% set expiryUnit = campaign.invitationExpiryPeriod|slice(-1) %}
    {% elseif campaign.invitationExpiryPeriod matches '/^PT(\\d+)H$/' %}
        {% set expiryValue = campaign.invitationExpiryPeriod|replace('/[^0-9]/', '') %}
        {% set expiryUnit = 'H' %}
    {% endif %}

    {# ==================== MAIN TAB ==================== #}
    <div id="fields">
        {# Title #}
        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: campaign.title,
            errors: campaign.getErrors('title'),
            first: true,
            autofocus: true,
            required: true,
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        {# Campaign Type #}
        {% if campaignTypeOptions %}
            {{ forms.selectField({
                label: 'Campaign Type'|t('campaign-manager'),
                id: 'campaignType',
                name: 'campaignType',
                value: campaign.campaignType,
                options: [{label: '', value: ''}]|merge(campaignTypeOptions|keys|map(k => {label: campaignTypeOptions[k], value: k})),
                errors: campaign.getErrors('campaignType'),
            }) }}
        {% endif %}

        {# Form #}
        {% if formOptions|length %}
            {{ forms.selectField({
                label: 'Form'|t('campaign-manager'),
                instructions: 'Select a Formie form to link with this campaign.'|t('campaign-manager'),
                id: 'formId',
                name: 'formId',
                value: campaign.formId,
                options: [{label: 'Select a form'|t('campaign-manager'), value: ''}]|merge(formOptions),
                errors: campaign.getErrors('formId'),
                required: true,
            }) }}
        {% endif %}

        <hr>

        <h2>{{ 'Invitation Settings'|t('campaign-manager') }}</h2>

        {# Invitation Delay Period #}
        <div class="field">
            <div class="heading">
                <label for="invitationDelayValue">{{ 'Invitation Delay'|t('campaign-manager') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'How long to wait before sending invitations after a customer is added. Leave empty or 0 to send immediately.'|t('campaign-manager') }}</p>
            </div>
            <div class="flex">
                <div class="textwrapper">
                    {{ forms.text({
                        id: 'invitationDelayValue',
                        name: 'invitationDelayValue',
                        value: delayValue,
                        type: 'number',
                        min: 0,
                        size: 5,
                        placeholder: '0',
                    }) }}
                </div>
                <div>
                    {{ forms.select({
                        id: 'invitationDelayUnit',
                        name: 'invitationDelayUnit',
                        value: delayUnit,
                        options: durationUnits,
                    }) }}
                </div>
            </div>
            {% if campaign.getErrors('invitationDelayPeriod') %}
                <ul class="errors">
                    {% for error in campaign.getErrors('invitationDelayPeriod') %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>

        {# Invitation Expiry Period #}
        <div class="field">
            <div class="heading">
                <label for="invitationExpiryValue">{{ 'Invitation Expiry'|t('campaign-manager') }}</label>
            </div>
            <div class="instructions">
                <p>{{ 'How long the invitation link remains valid.'|t('campaign-manager') }}</p>
            </div>
            <div class="flex">
                <div class="textwrapper">
                    {{ forms.text({
                        id: 'invitationExpiryValue',
                        name: 'invitationExpiryValue',
                        value: expiryValue,
                        type: 'number',
                        min: 0,
                        size: 5,
                        placeholder: '0',
                    }) }}
                </div>
                <div>
                    {{ forms.select({
                        id: 'invitationExpiryUnit',
                        name: 'invitationExpiryUnit',
                        value: expiryUnit,
                        options: durationUnits,
                    }) }}
                </div>
            </div>
            {% if campaign.getErrors('invitationExpiryPeriod') %}
                <ul class="errors">
                    {% for error in campaign.getErrors('invitationExpiryPeriod') %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    </div>

    {# ==================== MESSAGING TAB (SMS + Email) ==================== #}
    <div id="messaging" class="hidden">
        <h2>{{ 'SMS Settings'|t('campaign-manager') }}</h2>

        {# Sender ID #}
        {% if senderIdOptions|length %}
            {{ forms.selectField({
                label: 'Sender ID'|t('campaign-manager'),
                id: 'senderId',
                name: 'senderId',
                value: campaign.senderId,
                options: senderIdOptions,
                errors: campaign.getErrors('senderId'),
            }) }}
        {% endif %}

        {# SMS Invitation Message #}
        {{ forms.textareaField({
            label: 'SMS Invitation Message'|t('campaign-manager'),
            instructions: 'Use {invitationUrl} to include the invitation link.'|t('campaign-manager'),
            id: 'smsInvitationMessage',
            name: 'smsInvitationMessage',
            value: campaign.smsInvitationMessage,
            rows: 3,
            errors: campaign.getErrors('smsInvitationMessage'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        <hr>

        <h2>{{ 'Email Settings'|t('campaign-manager') }}</h2>

        {# Email Subject #}
        {{ forms.textField({
            label: 'Email Invitation Subject'|t('campaign-manager'),
            id: 'emailInvitationSubject',
            name: 'emailInvitationSubject',
            value: campaign.emailInvitationSubject,
            errors: campaign.getErrors('emailInvitationSubject'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}

        {# Email Invitation Message #}
        {{ forms.textareaField({
            label: 'Email Invitation Message'|t('campaign-manager'),
            instructions: 'Use {invitationUrl} to include the invitation link. HTML is supported.'|t('campaign-manager'),
            id: 'emailInvitationMessage',
            name: 'emailInvitationMessage',
            value: campaign.emailInvitationMessage,
            rows: 6,
            errors: campaign.getErrors('emailInvitationMessage'),
            translatable: craft.app.getIsMultiSite() ? 'site' : false,
            orientation: siteOrientation,
        }) }}
    </div>

    {# ==================== FIELD LAYOUT TABS ==================== #}
    {% if fieldLayout %}
        {% for tab in fieldLayout.getTabs() %}
            <div id="tab-fl-{{ tab.id }}" class="hidden">
                {% for element in tab.getElements() %}
                    {{ element.formHtml(campaign)|raw }}
                {% endfor %}
            </div>
        {% endfor %}
    {% endif %}
{% endblock %}

{% block details %}
    <div class="meta">
        {# Enabled #}
        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: campaign.enabled,
        }) }}

        {% if campaign.id %}
            <div class="field" style="margin-top: 15px;">
                <div class="heading">
                    <label>{{ 'Actions'|t('app') }}</label>
                </div>
                <div class="input">
                    <div class="btngroup" style="width: 100%;">
                        <button type="button" class="btn menubtn" data-icon="settings" style="width: 100%;">{{ 'Campaign Actions'|t('campaign-manager') }}</button>
                        <div class="menu">
                            <ul>
                                <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/customers?site=' ~ currentSite.handle) }}">{{ 'View Customers'|t('campaign-manager') }}</a></li>
                                <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/add-customer?site=' ~ currentSite.handle) }}">{{ 'Add Customer'|t('campaign-manager') }}</a></li>
                                <li><a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/import-customers?site=' ~ currentSite.handle) }}">{{ 'Import Customers'|t('campaign-manager') }}</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    {% if campaign.id %}
        <div class="meta read-only">
            <div class="data">
                <h5 class="heading">{{ 'Date Created'|t('app') }}</h5>
                <div class="value">{{ campaign.dateCreated|datetime('short') }}</div>
            </div>
            <div class="data">
                <h5 class="heading">{{ 'Date Updated'|t('app') }}</h5>
                <div class="value">{{ campaign.dateUpdated|datetime('short') }}</div>
            </div>
            <div class="data">
                <h5 class="heading">{{ 'Customers'|t('campaign-manager') }}</h5>
                <div class="value">
                    <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id ~ '/customers?site=' ~ currentSite.handle) }}">
                        {{ campaign.customerCount }}
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
