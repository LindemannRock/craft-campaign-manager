{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('campaign-manager') %}
{% set settings = plugin.getSettings() %}

{# Site and campaign are passed from controller #}
{% set site = site ?? craft.app.sites.getCurrentSite() %}
{% set campaignId = campaignId ?? campaign.id %}

{% set title = 'Import Recipients'|t('campaign-manager') %}
{% set fullPageForm = true %}
{% set mainFormAttributes = {
    method: 'post',
    action: actionUrl('campaign-manager/recipients/upload'),
    enctype: 'multipart/form-data',
} %}
{% set selectedSubnavItem = 'campaigns' %}

{# Get enabled sites for this campaign #}
{% set enabledSites = [] %}
{% for s in craft.app.sites.getEditableSites() %}
    {% set campaignForSite = craft.campaignManager.campaigns.find().id(campaignId).siteId(s.id).status(null).one() %}
    {% if campaignForSite and campaignForSite.getEnabledForSite() %}
        {% set enabledSites = enabledSites|merge([s]) %}
    {% endif %}
{% endfor %}

{# Check if campaign is enabled for any site #}
{% set campaignDisabled = enabledSites|length == 0 %}

{# Site switcher in crumbs - only show enabled sites #}
{% set crumbs = [] %}
{% if craft.app.getIsMultiSite() and enabledSites|length > 1 %}
    {% set siteMenuItems = [] %}
    {% for s in enabledSites %}
        {% set siteMenuItems = siteMenuItems|merge([{
            label: s.name,
            url: cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/import-recipients', {site: s.handle}),
            selected: s.handle == site.handle
        }]) %}
    {% endfor %}

    {% set crumbs = [{
        id: 'site-crumb',
        icon: 'world',
        label: site.name|t('site'),
        menu: {
            items: siteMenuItems,
            label: 'Select site'|t('app')
        }
    }] %}
{% endif %}

{% set crumbs = crumbs|merge([
    { label: settings.pluginName, url: cpUrl('campaign-manager', {site: site.handle}) },
    { label: campaign.title, url: cpUrl('campaign-manager/campaigns/' ~ campaignId, {site: site.handle}) },
    { label: 'Recipients'|t('campaign-manager'), url: cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/recipients', {site: site.handle}) },
    { label: 'Import'|t('campaign-manager') },
]) %}

{% block content %}
    {% if campaignDisabled %}
        {% include 'lindemannrock-base/_components/info-box' with {
            message: 'This campaign is disabled for all sites. Enable it for at least one site before importing recipients.'|t('campaign-manager'),
            type: 'warning',
        } %}
    {% else %}
        {% if errors is defined %}
            <div class="pane error" style="margin-bottom: 24px;">
                <p><strong>{{ 'Error:'|t('campaign-manager') }}</strong></p>
                <p>{{ errors }}</p>
            </div>
        {% endif %}

        <h2 style="margin-top: 0;">{{ 'Import Recipients from CSV'|t('campaign-manager') }}</h2>

    <p>{{ 'Upload a CSV file to import recipients into this campaign. You will be able to map columns and preview before importing.'|t('campaign-manager') }}</p>

    {% set csvFormatTip %}
        <h4>{{ 'CSV Format'|t('campaign-manager') }}</h4>
        <p><strong>{{ 'Required columns:'|t('campaign-manager') }}</strong></p>
        <ul>
            <li><code>Name</code> - {{ 'Recipient name'|t('campaign-manager') }}</li>
        </ul>
        <p><strong>{{ 'Optional columns:'|t('campaign-manager') }}</strong></p>
        <ul>
            <li><code>Email</code> - {{ 'Email address for email invitations'|t('campaign-manager') }}</li>
            <li><code>Phone</code> / <code>SMS</code> - {{ 'Phone number for SMS invitations'|t('campaign-manager') }}</li>
            <li><code>Site</code> - {{ 'Site handle (e.g., en, ar)'|t('campaign-manager') }}</li>
        </ul>
        <p><strong>{{ 'Example:'|t('campaign-manager') }}</strong></p>
        <pre style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">Name,Email,Phone,Site
John Doe,john@example.com,96512345678,en
Ahmed Ali,ahmed@example.com,96598765432,ar</pre>
    {% endset %}

    {{ hiddenInput('campaignId', campaignId) }}

    {% set maxRows = importLimits.maxRows ?? 4000 %}
    {% set maxBytes = importLimits.maxBytes ?? 5242880 %}
    {% set maxSize = craft.app.formatter.asShortSize(maxBytes, 2) %}

    {% include 'lindemannrock-base/_partials/import-csv' with {
        wrapForm: false,
        formId: 'recipient-upload-form',
        title: 'CSV File Format'|t('campaign-manager'),
        description: 'Your CSV should include Name, Email, Phone, and Site columns. Click the info icon for details.'|t('campaign-manager'),
        csvFormatTip: csvFormatTip,
        fileLabel: 'CSV File'|t('campaign-manager'),
        fileInstructions: 'Select a CSV file to import recipients. Delimiter (comma, semicolon, tab) is auto-detected.'|t('campaign-manager'),
        fileId: 'csvFile',
        fileName: 'csvFile',
        delimiterLabel: 'CSV Delimiter'|t('campaign-manager'),
        delimiterInstructions: 'Character used to separate values in your CSV (auto-detect is default)'|t('campaign-manager'),
        delimiterValue: 'auto',
        delimiterOptions: {
            'auto': 'Auto (detect)'|t('campaign-manager'),
            ',': 'Comma (,)'|t('campaign-manager'),
            ';': 'Semicolon (;)'|t('campaign-manager'),
            "\t": 'Tab'|t('campaign-manager'),
            '|': 'Pipe (|)'|t('campaign-manager'),
        },
        showBackupToggle: false,
        infoBoxMessage: 'The maximum file size is {size} and the import is limited to {rows} rows per file.'|t('campaign-manager', {
            size: maxSize,
            rows: maxRows|number_format
        }),
        submitLabel: 'Upload & Map Columns'|t('campaign-manager'),
    } %}
    {% endif %}
{% endblock %}

{% block details %}
    {% if not campaignDisabled %}
    <fieldset>
        <div class="meta">
            {{ forms.lightswitchField({
                label: 'Send Invitation'|t('campaign-manager'),
                instructions: 'Queue invitation to be sent after adding.'|t('campaign-manager'),
                id: 'queueSending',
                name: 'queueSending',
                on: true,
            }) }}

            <div class="field">
                <div class="heading">
                    <label>{{ 'Campaign'|t('campaign-manager') }}</label>
                </div>
                <div class="input">
                    <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/recipients', {site: site.handle}) }}">{{ campaign.title }}</a>
                </div>
            </div>

            <div class="field">
                <div class="heading">
                    <label>{{ 'Template'|t('campaign-manager') }}</label>
                </div>
                <div class="input">
                    <button type="button" class="btn" id="download-template-btn">{{ 'Download CSV Template'|t('campaign-manager') }}</button>
                </div>
            </div>
        </div>
    </fieldset>
    {% endif %}
{% endblock %}

{% js %}
document.getElementById('download-template-btn').addEventListener('click', function() {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '';
    form.style.display = 'none';

    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
    csrfInput.value = '{{ craft.app.request.csrfToken }}';
    form.appendChild(csrfInput);

    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'campaign-manager/recipients/download-sample';
    form.appendChild(actionInput);

    document.body.appendChild(form);
    form.submit();
});
{% endjs %}
