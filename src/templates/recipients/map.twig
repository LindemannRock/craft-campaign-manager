{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('campaign-manager') %}
{% set settings = plugin.getSettings() %}

{# Site and campaign are passed from controller #}
{% set site = site ?? craft.app.sites.getCurrentSite() %}
{% set campaignId = campaignId ?? campaign.id %}

{# Get enabled sites for this campaign #}
{% set enabledSites = [] %}
{% for s in craft.app.sites.getEditableSites() %}
    {% set campaignForSite = craft.campaignManager.campaigns.find().id(campaignId).siteId(s.id).status(null).one() %}
    {% if campaignForSite and campaignForSite.getEnabledForSite() %}
        {% set enabledSites = enabledSites|merge([s]) %}
    {% endif %}
{% endfor %}

{% set title = 'Map CSV Columns'|t('campaign-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'campaigns' %}

{# Site switcher in crumbs - only show enabled sites #}
{% set crumbs = [] %}
{% if craft.app.getIsMultiSite() and enabledSites|length > 1 %}
    {% set siteMenuItems = [] %}
    {% for s in enabledSites %}
        {% set siteMenuItems = siteMenuItems|merge([{
            label: s.name,
            url: cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/import-recipients', {site: s.handle}),
            selected: s.handle == site.handle
        }]) %}
    {% endfor %}

    {% set crumbs = [{
        id: 'site-crumb',
        icon: 'world',
        label: site.name|t('site'),
        menu: {
            items: siteMenuItems,
            label: 'Select site'|t('app')
        }
    }] %}
{% endif %}

{% set crumbs = crumbs|merge([
    { label: settings.pluginName, url: cpUrl('campaign-manager', {site: site.handle}) },
    { label: campaign.title, url: cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/recipients', {site: site.handle}) },
    { label: 'Import Recipients'|t('campaign-manager'), url: cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/import-recipients', {site: site.handle}) },
]) %}

{% block content %}
    <h2 style="margin-top: 0;">{{ 'Map CSV Columns'|t('campaign-manager') }}</h2>

    <p>{{ 'Your CSV has {count} rows. Map each CSV column to a recipient field.'|t('campaign-manager', {count: rowCount}) }}</p>

    <h3>{{ 'Preview of CSV Data'|t('campaign-manager') }}</h3>
    <div style="overflow-x: auto; margin-bottom: 30px;">
        <table class="data fullwidth">
            <thead>
                <tr>
                    {% for header in headers %}
                        <th>{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in previewRows %}
                    <tr>
                        {% for cell in row %}
                            <td><code>{{ cell }}</code></td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if rowCount > 5 %}
            <p class="light" style="margin-top: 10px;">{{ 'Showing first 5 rows. {total} total rows will be imported.'|t('campaign-manager', {total: rowCount}) }}</p>
        {% endif %}
    </div>

    <hr>

    <h3>{{ 'Column Mapping'|t('campaign-manager') }}</h3>
    <p>{{ 'Map your CSV columns to recipient fields. Name and at least one of Email or Phone must be mapped.'|t('campaign-manager') }}<br>
    <span class="light">{{ '* At least one required'|t('campaign-manager') }}</span></p>

    <form method="post" action="{{ actionUrl('campaign-manager/recipients/preview') }}">
        {{ csrfInput() }}
        {{ hiddenInput('campaignId', campaignId) }}
        {{ hiddenInput('queueSending', queueSending ? '1' : '0') }}

        {% set fieldOptions = [
            {value: '', label: '-- Do not import --'|t('campaign-manager')},
            {value: 'name', label: 'Name (required)'|t('campaign-manager')},
            {value: 'email', label: 'Email (required*)'|t('campaign-manager')},
            {value: 'sms', label: 'Phone / SMS (required*)'|t('campaign-manager')},
            {value: 'site', label: 'Site'|t('campaign-manager')},
        ] %}

        <div class="field">
            <div class="input">
                <table class="editable fullwidth">
                    <thead>
                        <tr>
                            <th style="width: 30%;">{{ 'CSV Column'|t('campaign-manager') }}</th>
                            <th style="width: 40%;">{{ 'Maps to Field'|t('campaign-manager') }}</th>
                            <th style="width: 30%;">{{ 'Sample Data'|t('campaign-manager') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for i, header in headers %}
                            <tr>
                                <td><strong>{{ header }}</strong></td>
                                <td>
                                    <div class="select fullwidth">
                                        <select name="mapping[{{ i }}]" class="column-mapping">
                                            {% for option in fieldOptions %}
                                                {% set isMatch = false %}
                                                {% set lowerHeader = header|lower %}

                                                {# Auto-detect mapping based on header name #}
                                                {% if option.value == 'name' and (lowerHeader in ['name', 'recipient name', 'recipient_name', 'recipientname', 'full name', 'fullname', 'full_name']) %}
                                                    {% set isMatch = true %}
                                                {% elseif option.value == 'email' and (lowerHeader in ['email', 'e-mail', 'email address', 'emailaddress', 'email_address', 'mail']) %}
                                                    {% set isMatch = true %}
                                                {% elseif option.value == 'sms' and (lowerHeader in ['sms', 'phone', 'mobile', 'telephone', 'tel', 'phone number', 'phonenumber', 'phone_number', 'mobile number', 'mobilenumber', 'mobile_number', 'cell', 'cellphone']) %}
                                                    {% set isMatch = true %}
                                                {% elseif option.value == 'site' and (lowerHeader in ['site', 'language', 'lang', 'locale', 'site_language']) %}
                                                    {% set isMatch = true %}
                                                {% endif %}

                                                <option value="{{ option.value }}" {% if isMatch %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </td>
                                <td>
                                    <code class="light">{{ previewRows[0][i] ?? '-' }}</code>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% include 'lindemannrock-base/_components/info-box' with {
            message: '',
            type: 'error',
            variant: 'colored',
            margin: 'both',
            boxId: 'mappingErrors',
            messageId: 'mappingErrorText',
            hidden: true
        } only %}

        <hr style="margin: 30px 0;">

        <h3>{{ 'Phone Number Settings'|t('campaign-manager') }}</h3>

        {# Get allowed countries from campaign's provider #}
        {% set providerHandle = campaign.providerHandle ?? settings.defaultProviderHandle %}
        {% set allowedCountries = providerHandle ? craft.campaignManager.sms.getAllowedCountries(providerHandle) : [] %}
        {% set isAllCountries = allowedCountries == ['*'] %}

        {% if allowedCountries|length > 0 %}
            <p>{{ 'Select the country for phone numbers in the CSV. Numbers with country codes (e.g., +965...) will be auto-detected.'|t('campaign-manager') }}</p>

            {# Build country options #}
            {% set countryOptions = [] %}
            {% if isAllCountries %}
                {% for option in lrDialCodes() %}
                    {% set dc = lrDialCode(option.value) %}
                    {% if dc %}
                        {% set countryOptions = countryOptions|merge([{
                            label: option.value ~ ' +' ~ dc ~ ' - ' ~ lrCountryName(option.value),
                            value: option.value
                        }]) %}
                    {% endif %}
                {% endfor %}
            {% else %}
                {% for code in allowedCountries %}
                    {% set dialCode = lrDialCode(code) %}
                    {% if dialCode %}
                        {% set countryOptions = countryOptions|merge([{
                            label: code ~ ' +' ~ dialCode ~ ' - ' ~ lrCountryName(code),
                            value: code
                        }]) %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            <div class="field" style="margin-top: 10px;">
                <div class="heading">
                    <label for="phoneCountry">{{ 'Phone Country'|t('campaign-manager') }}</label>
                </div>
                <div class="input">
                    <div class="select">
                        <select id="phoneCountry" name="phoneCountry">
                            {% for option in countryOptions %}
                                <option value="{{ option.value }}" {% if loop.first %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            {% include 'lindemannrock-base/_components/info-box' with {
                message: 'Phone numbers can be local (e.g., 94400999) or include country code (e.g., 96594400999). Numbers with country codes will be validated against allowed countries.'|t('campaign-manager'),
                type: 'tip',
                margin: 'top'
            } only %}
        {% else %}
            {% include 'lindemannrock-base/_components/info-box' with {
                message: 'No SMS provider configured. Phone numbers will be skipped during import.'|t('campaign-manager'),
                type: 'warning',
                margin: 'none'
            } only %}
            {{ hiddenInput('phoneCountry', '') }}
        {% endif %}

        <hr style="margin: 30px 0;">

        <h3>{{ 'Default Site'|t('campaign-manager') }}</h3>
        <p>{{ 'Used as fallback when the Site column is not mapped, or when a row has an empty/invalid site value.'|t('campaign-manager') }}</p>

        <div class="input" style="margin-top: 10px;">
            <div class="select">
                <select id="defaultSiteId" name="defaultSiteId">
                    {% for s in enabledSites %}
                        <option value="{{ s.id }}" {% if s.id == site.id %}selected{% endif %}>
                            {{ s.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <hr style="margin: 30px 0;">

        <div class="buttons">
            <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/import-recipients', {site: site.handle}) }}" class="btn">{{ 'Cancel'|t('campaign-manager') }}</a>
            <button type="submit" class="btn submit" id="importBtn">{{ 'Preview Import'|t('campaign-manager') }}</button>
        </div>
    </form>
{% endblock %}

{% block details %}
    <fieldset>
        <div class="meta">
            {{ forms.lightswitchField({
                label: 'Send Invitations'|t('campaign-manager'),
                instructions: 'Queue invitation sending after import.'|t('campaign-manager'),
                id: 'queueSendingToggle',
                name: 'queueSendingToggle',
                on: queueSending
            }) }}

            <div class="field">
                <div class="heading">
                    <label>{{ 'Campaign'|t('campaign-manager') }}</label>
                </div>
                <div class="input">
                    <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaignId ~ '/recipients', {site: site.handle}) }}">{{ campaign.title }}</a>
                </div>
            </div>

            <div class="field">
                <div class="heading">
                    <label>{{ 'Rows to Import'|t('campaign-manager') }}</label>
                </div>
                <div class="input">
                    <strong>{{ rowCount|number }}</strong>
                </div>
            </div>
        </div>
    </fieldset>
{% endblock %}

{% js %}
    // Validate required fields are mapped before submitting
    const importBtn = document.getElementById('importBtn');
    const mappingErrorDiv = document.getElementById('mappingErrors');
    const mappingErrorText = document.getElementById('mappingErrorText');
    const form = document.querySelector('form');

    form.addEventListener('submit', function(e) {
        const mappings = document.querySelectorAll('.column-mapping');
        const selectedValues = Array.from(mappings).map(m => m.value);

        // Check required fields
        const hasName = selectedValues.includes('name');
        const hasEmail = selectedValues.includes('email');
        const hasSms = selectedValues.includes('sms');

        let errors = [];

        if (!hasName) {
            errors.push('Name');
        }

        if (!hasEmail && !hasSms) {
            errors.push('Email or Phone');
        }

        if (errors.length > 0) {
            e.preventDefault();
            mappingErrorDiv.style.display = 'block';
            mappingErrorText.innerHTML = '<strong>Required fields not mapped: ' + errors.join(', ') + '</strong>';
            mappingErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }

        // Check for duplicate mappings
        const nonEmptyMappings = selectedValues.filter(v => v !== '');
        const uniqueMappings = new Set(nonEmptyMappings);

        if (nonEmptyMappings.length !== uniqueMappings.size) {
            e.preventDefault();
            mappingErrorDiv.style.display = 'block';
            mappingErrorText.innerHTML = '<strong>Error: You cannot map multiple CSV columns to the same field</strong>';
            mappingErrorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }

        mappingErrorDiv.style.display = 'none';
    });

    // Clear error when user changes mapping
    document.querySelectorAll('.column-mapping').forEach(select => {
        select.addEventListener('change', function() {
            mappingErrorDiv.style.display = 'none';
        });
    });

    // Sync sidebar toggle with hidden form input
    const queueSendingToggle = document.getElementById('queueSendingToggle');
    const queueSendingInput = document.querySelector('input[name="queueSending"]');
    if (queueSendingToggle && queueSendingInput) {
        queueSendingToggle.addEventListener('change', function() {
            queueSendingInput.value = this.classList.contains('on') ? '1' : '0';
        });
    }
{% endjs %}
