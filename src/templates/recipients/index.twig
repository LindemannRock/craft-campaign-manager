{#
 # Recipients Index - Using cp-table layout
 #
 # Global view of all recipients across all campaigns with filters,
 # sorting, and bulk actions.
 #}

{% extends 'lindemannrock-base/_layouts/cp-table' %}

{# ============================================================================
   PERMISSION CHECKS
   ============================================================================ #}

{% set canView = currentUser.can('campaignManager:viewRecipients') %}
{% set canDelete = currentUser.can('campaignManager:deleteRecipients') %}

{# ============================================================================
   GET QUERY PARAMETERS (from controller, fallback to request for safety)
   ============================================================================ #}

{% set search = search ?? craft.app.request.getParam('search', '') %}
{% set campaignFilter = campaignFilter ?? craft.app.request.getParam('campaign', 'all') %}
{% set statusFilter = statusFilter ?? craft.app.request.getParam('status', 'all') %}
{% set siteFilterParam = siteFilterParam ?? craft.app.request.getParam('siteFilter', 'all') %}
{% set dateRange = dateRange ?? craft.app.request.getParam('dateRange', defaultDateRange ?? 'last30days') %}
{% set sort = sort ?? craft.app.request.getParam('sort', 'sent') %}
{% set dir = dir ?? craft.app.request.getParam('dir', 'desc') %}
{% set page = page ?? craft.app.request.getParam('page', 1)|number_format(0, '', '') %}
{% set limit = limit ?? 50 %}
{% set totalCount = totalCount ?? 0 %}
{% set paginatedRecipients = recipients %}

{# ============================================================================
   BUILD FILTER OPTIONS
   ============================================================================ #}

{# Campaign options #}
{% set campaignFilterOptions = [{value: 'all', label: 'All Campaigns'|t('campaign-manager'), status: 'all'}] %}
{% for option in campaignOptions %}
    {% set campaignFilterOptions = campaignFilterOptions|merge([{
        value: option.value,
        label: option.label,
    }]) %}
{% endfor %}

{# Site options #}
{% set siteFilterOptions = [{value: 'all', label: 'All Sites'|t('campaign-manager'), status: 'all'}] %}
{% for site in craft.app.sites.getEditableSites() %}
    {% set siteFilterOptions = siteFilterOptions|merge([{
        value: site.id,
        label: site.name,
    }]) %}
{% endfor %}

{# ============================================================================
   TABLE CONFIGURATION
   ============================================================================ #}

{% set tableConfig = {
    plugin: {
        handle: pluginHandle ?? 'campaign-manager',
        name: settings.fullName,
    },
    page: {
        title: 'Recipients'|t('campaign-manager'),
        subnav: 'recipients',
        crumbs: [
            { label: settings.fullName, url: url('campaign-manager') },
            { label: 'Recipients'|t('campaign-manager') }
        ],
    },
    filters: [
        {
            type: 'status',
            param: 'status',
            current: statusFilter,
            label: 'All'|t('campaign-manager'),
            colorSet: 'messageStatus',
            options: [
                {value: 'all', label: 'All'|t('campaign-manager'), status: 'all'},
                {value: 'pending', label: 'Pending'|t('campaign-manager'), colorKey: 'pending'},
                {value: 'sent', label: 'Sent'|t('campaign-manager'), colorKey: 'sent'},
            ],
        },
        {
            type: 'dropdown',
            param: 'campaign',
            current: campaignFilter,
            label: 'All Campaigns'|t('campaign-manager'),
            options: campaignFilterOptions,
        },
        {
            type: 'dropdown',
            param: 'siteFilter',
            current: siteFilterParam,
            label: 'All Sites'|t('campaign-manager'),
            options: siteFilterOptions,
        },
        {
            type: 'dateRange',
            param: 'dateRange',
            current: dateRange,
            label: 'Date Range'|t('campaign-manager'),
        },
    ],
    search: {
        placeholder: 'Search recipients...'|t('campaign-manager'),
        value: search,
    },
    sort: {
        field: sort,
        direction: dir,
    },
    table: {
        columns: [
            {key: 'name', label: 'Name'|t('campaign-manager'), sortable: true},
            {key: 'campaign', label: 'Campaign'|t('campaign-manager'), sortable: true},
            {key: 'contact', label: 'Contact'|t('campaign-manager')},
            {key: 'status', label: 'Status'|t('campaign-manager')},
            {key: 'sent', label: 'Sent'|t('campaign-manager'), sortable: true},
            {key: 'opened', label: 'Opened'|t('campaign-manager'), sortable: true},
            {key: 'response', label: 'Response'|t('campaign-manager')},
        ],
        items: paginatedRecipients,
        emptyMessage: 'No recipients found.'|t('campaign-manager'),
    },
    pagination: {
        page: page,
        limit: limit,
        totalCount: totalCount,
        itemLabel: {singular: 'recipient'|t('campaign-manager'), plural: 'recipients'|t('campaign-manager')},
    },
    checkboxes: canDelete,
} %}


{# ============================================================================
   TOOLBAR ACTIONS (Export button)
   ============================================================================ #}

{% block toolbarActions %}
    {% include 'lindemannrock-base/_components/export-menu' with {
        action: 'campaign-manager/recipients/export',
        permission: 'campaignManager:exportRecipients',
        pluginHandle: pluginHandle,
        extraParams: {
            campaign: campaignFilter,
            siteFilter: siteFilterParam,
            status: statusFilter,
        },
    } only %}
{% endblock %}


{# ============================================================================
   BULK ACTIONS (shown when items selected)
   ============================================================================ #}

{% block bulkActions %}
    {% if canDelete %}
        <button type="button" class="btn secondary" id="lr-bulk-delete-btn">
            {{ 'Delete'|t('app') }} (<span id="lr-selected-count">0</span>)
        </button>
    {% endif %}
{% endblock %}


{# ============================================================================
   ROW ACTIONS (per-row menu)
   ============================================================================ #}

{% block rowActions %}
    <td class="thin" style="text-align: right;">
        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></button>
        <div class="menu">
            <ul>
                {% if item.submissionId %}
                    {% set submission = craft.formie.submissions.id(item.submissionId).one() %}
                    {% if submission %}
                        <li>
                            <a href="{{ submission.cpEditUrl }}">
                                {{ 'View Response'|t('campaign-manager') }}
                            </a>
                        </li>
                        <li><hr class="padded"></li>
                    {% endif %}
                {% endif %}
                {% if canDelete %}
                    <li>
                        <a class="lr-recipient-action error" data-action="delete" data-id="{{ item.id }}" data-name="{{ item.name }}">
                            {{ 'Delete'|t('app') }}
                        </a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM TABLE ROW RENDERING
   ============================================================================ #}

{% block tableRow %}
    {# Get campaign for this recipient #}
    {% set campaign = craft.campaignManager.campaigns.getCampaignById(item.campaignId) %}
    {% set site = craft.app.sites.getSiteById(item.siteId) %}

    {# Determine status #}
    {% if item.smsSendDate or item.emailSendDate %}
        {% set statusValue = 'sent' %}
        {% set statusLabel = 'Sent'|t('campaign-manager') %}
    {% else %}
        {% set statusValue = 'pending' %}
        {% set statusLabel = 'Pending'|t('campaign-manager') %}
    {% endif %}

    {# Name #}
    <td>
        <span>{{ item.name }}</span>
        {% if site %}
            <span class="light" style="margin-left: 4px;">({{ site.language|upper[:2] }})</span>
        {% endif %}
    </td>

    {# Campaign #}
    <td>
        {% if campaign %}
            <a href="{{ cpUrl('campaign-manager/campaigns/' ~ campaign.id, {site: site.handle ?? 'en'}) }}">
                {{ campaign.title }}
            </a>
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Contact (Email / SMS) #}
    <td>
        {% if item.email %}
            <code style="font-size: 11px;">{{ item.email }}</code>
        {% endif %}
        {% if item.email and item.sms %}<br>{% endif %}
        {% if item.sms %}
            <code style="font-size: 11px;">{{ item.sms }}</code>
        {% endif %}
        {% if not item.email and not item.sms %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Status indicator #}
    <td>
        {% include 'lindemannrock-base/_components/badge' with {
            label: statusLabel,
            value: statusValue,
            colorSet: 'messageStatus',
        } only %}
    </td>

    {# Sent date #}
    <td>
        {% set sentDate = item.smsSendDate ?? item.emailSendDate %}
        {% if sentDate %}
            {{ sentDate|lrDatetime('medium') }}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Opened date #}
    <td>
        {% set openedDate = item.smsOpenDate ?? item.emailOpenDate %}
        {% if openedDate %}
            {{ openedDate|lrDatetime('medium') }}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>

    {# Submission #}
    <td>
        {% if item.submissionId %}
            {% set submission = craft.formie.submissions.id(item.submissionId).one() %}
            {% if submission %}
                <a href="{{ submission.cpEditUrl }}">{{ item.submissionId }}</a>
            {% else %}
                <span class="light">{{ item.submissionId }}</span>
            {% endif %}
        {% else %}
            <span class="light">-</span>
        {% endif %}
    </td>
{% endblock %}


{# ============================================================================
   CUSTOM SCRIPTS
   ============================================================================ #}

{% block scripts %}
    <script>
    (function() {
        // Update selected count when selection changes
        document.addEventListener('lr:selectionChanged', function(e) {
            const countSpan = document.getElementById('lr-selected-count');
            if (countSpan) {
                countSpan.textContent = e.detail.count;
            }
        });

        // Bulk delete
        document.getElementById('lr-bulk-delete-btn')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (!window.lrTableSelection) return;

            const ids = window.lrTableSelection.getSelectedIds();
            const count = window.lrTableSelection.getCount();

            if (count === 0) return;

            if (!confirm('{{ "Delete {count} recipient(s)? This cannot be undone."|t("campaign-manager")|e("js") }}'.replace('{count}', count))) {
                return;
            }

            Craft.sendActionRequest('POST', 'campaign-manager/recipients/bulk-delete', {
                data: { recipientIds: ids }
            }).then(function(response) {
                if (response.data.count > 0) {
                    Craft.cp.displayNotice('{{ "Deleted {count} recipients"|t("campaign-manager")|e("js") }}'.replace('{count}', response.data.count));
                }
                if (response.data.errors && response.data.errors.length > 0) {
                    response.data.errors.forEach(err => Craft.cp.displayError(err));
                }
                if (response.data.count > 0) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            }).catch(function(error) {
                Craft.cp.displayError('{{ "Failed to delete recipients"|t("campaign-manager")|e("js") }}');
            });
        });

        // Individual recipient action menu clicks
        document.querySelectorAll('.lr-recipient-action').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                const action = this.dataset.action;
                const recipientId = this.dataset.id;
                const recipientName = this.dataset.name;

                if (action === 'delete') {
                    if (confirm('{{ "Delete recipient \"{name}\"? This cannot be undone."|t("campaign-manager")|e("js") }}'.replace('{name}', recipientName))) {
                        Craft.sendActionRequest('POST', 'campaign-manager/recipients/delete-from-cp', {
                            data: { id: recipientId }
                        }).then(function(response) {
                            if (response.data.success) {
                                Craft.cp.displayNotice('{{ "Recipient deleted"|t("campaign-manager")|e("js") }}');
                                setTimeout(() => window.location.reload(), 1000);
                            } else if (response.data.error) {
                                Craft.cp.displayError(response.data.error);
                            }
                        }).catch(function(error) {
                            Craft.cp.displayError('{{ "Failed to delete recipient"|t("campaign-manager")|e("js") }}');
                        });
                    }
                }
            });
        });
    })();
    </script>
{% endblock %}
