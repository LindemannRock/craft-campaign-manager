{#
 # Campaign Analytics Dashboard
 #
 # Uses the centralized cp-analytics layout from base plugin.
 #}

{% extends 'lindemannrock-base/_layouts/cp-analytics' %}

{# ============================================================================
   ANALYTICS CONFIGURATION
   ============================================================================ #}

{% set analyticsConfig = {
    plugin: {
        handle: pluginHandle ?? 'campaign-manager',
        name: campaignManagerHelper.fullName,
    },
    page: {
        title: 'Analytics'|t('campaign-manager'),
        subnav: 'analytics',
        crumbs: [
            { label: campaignManagerHelper.fullName, url: url('campaign-manager') },
            { label: 'Analytics'|t('campaign-manager'), url: url('campaign-manager/analytics') },
        ],
    },
    tabs: {
        overview: { label: 'Overview'|t('campaign-manager') },
        delivery: { label: 'Delivery'|t('campaign-manager') },
        engagement: { label: 'Engagement'|t('campaign-manager') },
        conversion: { label: 'Conversion'|t('campaign-manager') },
    },
    filters: {
        dateRange: {
            current: dateRange,
        },
        sites: {
            enabled: craft.app.getIsMultiSite(),
            current: siteId == 'all' ? '' : siteId,
            sites: sites,
        },
        custom: [
            {
                param: 'campaign',
                current: campaignId,
                options: campaignOptions,
            },
        ],
    },
    export: {
        permission: 'campaignManager:exportAnalytics',
        action: 'campaign-manager/analytics/export',
    },
    charts: {
        prefix: 'cm',
        dataEndpoint: 'campaign-manager/analytics/get-data',
    },
} %}


{# ============================================================================
   TAB CONTENT
   ============================================================================ #}

{% block tabs %}
    {# Overview Tab #}
    <div id="overview" class="lr-tab-content">
        {% include 'campaign-manager/analytics/_partials/overview' %}
    </div>

    {# Delivery Tab #}
    <div id="delivery" class="lr-tab-content hidden">
        {% include 'campaign-manager/analytics/_partials/delivery' %}
    </div>

    {# Engagement Tab #}
    <div id="engagement" class="lr-tab-content hidden">
        {% include 'campaign-manager/analytics/_partials/engagement' %}
    </div>

    {# Conversion Tab #}
    <div id="conversion" class="lr-tab-content hidden">
        {% include 'campaign-manager/analytics/_partials/conversion' %}
    </div>
{% endblock %}


{# ============================================================================
   CHART INITIALIZATION
   ============================================================================ #}

{% block scripts %}
{% do view.registerAssetBundle('lindemannrock\\campaignmanager\\web\\assets\\analytics\\AnalyticsAsset') %}

{% set campaignStrings = {
    noActivity: 'No activity data available for the selected filters.'|t('campaign-manager'),
    noChannel: 'No channel data available for the selected filters.'|t('campaign-manager'),
    noEngagement: 'No engagement data available for the selected filters.'|t('campaign-manager'),
    noFunnel: 'No funnel data available for the selected filters.'|t('campaign-manager'),
    recipientsLabel: 'Recipients Added'|t('campaign-manager'),
    responsesLabel: 'Responses'|t('campaign-manager'),
    emailOpensLabel: 'Email Opens'|t('campaign-manager'),
    smsOpensLabel: 'SMS Opens'|t('campaign-manager'),
    countLabel: 'Count'|t('campaign-manager'),
} %}

{% set campaignAnalyticsConfig = {
    prefix: analyticsConfig.charts.prefix,
    dateRange: dateRange,
    siteId: siteId ?? '',
    csrfName: craft.app.config.general.csrfTokenName,
    csrfToken: craft.app.request.csrfToken,
    dataEndpoint: analyticsConfig.charts.dataEndpoint,
    customFilters: {
        campaign: campaignId,
    },
    strings: campaignStrings,
} %}

{% js %}
window.lrCampaignManagerAnalyticsInit({{ campaignAnalyticsConfig|json_encode|raw }});
{% endjs %}
{% endblock %}
