{# Conversion Tab - Response funnel and conversion metrics #}

{# Conversion Stats Grid #}
<div class="lr-unified-cards">
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: summaryStats.totalRecipients,
        description: 'Total Recipients'|t('campaign-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: summaryStats.totalOpened,
        description: 'Opened Invitations'|t('campaign-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: summaryStats.submissions,
        description: 'Form Responses'|t('campaign-manager'),
        align: 'center',
    } only %}

    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        value: summaryStats.conversionRate ~ '%',
        description: 'Conversion Rate'|t('campaign-manager'),
        align: 'center',
    } only %}
</div>

{# Conversion Funnel Chart #}
<div class="lr-analytics-charts">
    <div class="lr-chart-container full-width">
        <h3>{{ 'Conversion Funnel'|t('campaign-manager') }}</h3>
        <div class="lr-chart-height-250">
            <canvas id="funnel-chart"></canvas>
        </div>
    </div>
</div>

{# Funnel Breakdown Table #}
<div class="lr-chart-container lr-mt-24">
    <h3>{{ 'Funnel Breakdown'|t('campaign-manager') }}</h3>
    <div class="lr-table-scroll">
        <table class="data fullwidth">
            <thead>
                <tr>
                    <th>{{ 'Stage'|t('campaign-manager') }}</th>
                    <th class="lr-text-end">{{ 'Count'|t('campaign-manager') }}</th>
                    <th class="lr-text-end">{{ 'Percentage'|t('campaign-manager') }}</th>
                    <th class="lr-text-end">{{ 'Drop-off'|t('campaign-manager') }}</th>
                </tr>
            </thead>
            <tbody>
                {% set stages = [
                    { name: 'Total Recipients'|t('campaign-manager'), count: summaryStats.totalRecipients },
                    { name: 'Invitations Sent'|t('campaign-manager'), count: summaryStats.totalSent },
                    { name: 'Opened'|t('campaign-manager'), count: summaryStats.totalOpened },
                    { name: 'Responded'|t('campaign-manager'), count: summaryStats.submissions },
                ] %}
                {% set baseline = summaryStats.totalRecipients %}
                {% for stage in stages %}
                    {% set pct = baseline > 0 ? (stage.count / baseline * 100)|round(1) : 0 %}
                    {% set prevCount = loop.first ? stage.count : stages[loop.index0 - 1].count %}
                    {% set dropoff = prevCount > 0 ? ((prevCount - stage.count) / prevCount * 100)|round(1) : 0 %}
                    <tr>
                        <td><strong>{{ stage.name }}</strong></td>
                        <td class="lr-text-end">{{ stage.count|number_format }}</td>
                        <td class="lr-text-end">{{ pct }}%</td>
                        <td class="lr-text-end">
                            <span class="{{ loop.first ? 'lr-text-muted' : 'lr-text-red' }}">
                                {{ loop.first ? '-' : dropoff ~ '%' }}
                            </span>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# Tips #}
{% include 'lindemannrock-base/_components/info-box' with {
    type: 'tip',
    message: 'To improve conversion rates, consider: personalized messaging, shorter forms, mobile optimization, and timely follow-ups.'|t('campaign-manager'),
    margin: 'top',
} %}
